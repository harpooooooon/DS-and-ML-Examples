---
title: "Gapminder Lecture"
author: "Nipunjeet Gujral"
date: "last update: `r format(Sys.Date(), format = '%d %B %Y')`" 
output: 
  html_document:
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: true
  theme: flatly
  highlight: haddock
---

### Importing Appropriate Libraries

|Library  |   Purpose |
|---------|-----------------------------------------------------------------------------------|
|tidyverse| lends functional progaming aspects alongs with sql based data managment methods   | 
|gampinder| data derived from the WHO institute on population dynamics since 1952 to 2007 with 5 years intervals|
|knitr | allows html deliverable to include data table |


```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
library(tidyverse)
library(gapminder)
library(knitr)
getwd()
```


### Converting Unit of Analysis to Countries within a Continent
```{r message=FALSE, warning=FALSE}
by_country <- gapminder %>% 
  group_by(continent, country) %>% 
  nest() 
```

### View first 10 rows of Data
```{r}
knitr::kable(gapminder[1:10, ], caption = "Data Sample",
             float.environmnet = 'Sidewaystable')
```



### Formulating and apply Linear Regression Function between Life Expectancy and Year to grouped data
```{r message=FALSE, warning=FALSE}
country_model <- function(df){
 lm(lifeExp ~ year, data = df)
}

models <- by_country %>% 
  mutate( 
    model = map(data, country_model)
  )
```


### Adding columns filled with Regression Data
```{r message=FALSE, warning=FALSE}
model_sets <- models %>% 
  mutate(
    glance = map(model, broom::glance),
    rsq = glance %>% map_dbl("r.squared"),
    tidy = map(model, broom::tidy),
    augment = map(model, broom::augment)
  )
```



###  Plotting Regression Rervided Residuals against Time per Continent per Country
```{r message=FALSE, warning=FALSE}
model_sets %>% 
  unnest(augment) %>% 
  ggplot(aes(year, .resid)) +
    geom_line(aes(group = country), alpha = 1/3) +
    geom_smooth(se = FALSE) +
    geom_hline(yintercept = 0, colour = "pink") +
    facet_wrap(~continent)
```


```{r Model Digging, echo=FALSE, eval=FALSE}
# back to oringinal gapminder dataset
unnest(model_sets, data) 

# all general statistical data per country generated by the lm
unnest(model_sets, glance, .drop = TRUE) %>% 
  filter(continent == 'Asia',
         df.residual == 10) %>% 
  View()

# lm model statistics 
unnest(model_sets, tidy)
```


